services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: ims-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-medical_db}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - ims-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO Object Storage
  minio:
    image: minio/minio:latest
    container_name: ims-minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - ims-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    container_name: ims-api-gateway
    ports:
      - "8000:8000"
    networks:
      - ims-network
    depends_on:
      - user-patient-service
      - imaging-service
      - diagnosis-workflow-service
      - financial-service

  # User & Patient Service
  user-patient-service:
    build:
      context: .
      dockerfile: services/user-patient-service/Dockerfile
    container_name: ims-user-patient-service
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-medical_db}
      SERVICE_PORT: 8001
    ports:
      - "8001:8001"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ims-network
    volumes:
      - ./services/user-patient-service:/app

  # Imaging Service
  imaging-service:
    build:
      context: .
      dockerfile: services/imaging-service/Dockerfile
    container_name: ims-imaging-service
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-medical_db}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio:9000}
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-medical-images}
      MINIO_SECURE: "false"
      SERVICE_PORT: 8002
    ports:
      - "8002:8002"
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - ims-network
    volumes:
      - ./services/imaging-service:/app

  # Diagnosis & Workflow Service
  diagnosis-workflow-service:
    build:
      context: .
      dockerfile: services/diagnosis-workflow-service/Dockerfile
    container_name: ims-diagnosis-workflow-service
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-medical_db}
      SERVICE_PORT: 8003
    ports:
      - "8003:8003"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ims-network
    volumes:
      - ./services/diagnosis-workflow-service:/app

  # Financial Service
  financial-service:
    build:
      context: .
      dockerfile: services/financial-service/Dockerfile
    container_name: ims-financial-service
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-medical_db}
      SERVICE_PORT: 8004
    ports:
      - "8004:8004"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ims-network
    volumes:
      - ./services/financial-service:/app

volumes:
  postgres_data:
  minio_data:

networks:
  ims-network:
    driver: bridge
